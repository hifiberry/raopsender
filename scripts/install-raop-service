#!/usr/bin/env bash
set -euo pipefail

# install-raop-service
# Installs the RAOP audio linking systemd user service

########################################
# Safety checks
########################################
TARGET_USER="${SUDO_USER:-${USER:-}}"
TARGET_USER="$(echo "$TARGET_USER" | tr -d '\n' | xargs)"

if [ -z "$TARGET_USER" ]; then
  echo "Could not determine target user." >&2
  exit 1
fi

# If running as root, we need to install for the target user
if [ "$(id -u)" -eq 0 ]; then
    TARGET_HOME=$(getent passwd "$TARGET_USER" | cut -d: -f6)
else
    TARGET_HOME="$HOME"
    TARGET_USER="$USER"
fi

echo "Installing RAOP audio service for user: $TARGET_USER"
echo "Target home directory: $TARGET_HOME"

########################################
# Get script directory
########################################
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

########################################
# Install the audio linking script
########################################
echo "Installing audio linking script..."

# Create local bin directory
LOCAL_BIN_DIR="$TARGET_HOME/.local/bin"
mkdir -p "$LOCAL_BIN_DIR"

# Copy the audio linking script
LINK_SCRIPT="$SCRIPT_DIR/link-audio-to-raop.py"
if [ ! -f "$LINK_SCRIPT" ]; then
    echo "ERROR: link-audio-to-raop.py script not found at $LINK_SCRIPT" >&2
    exit 1
fi

cp "$LINK_SCRIPT" "$LOCAL_BIN_DIR/"
chmod +x "$LOCAL_BIN_DIR/link-audio-to-raop.py"

# Copy the RAOP sink selection script
SELECT_SCRIPT="$SCRIPT_DIR/select-raop-sink"
if [ ! -f "$SELECT_SCRIPT" ]; then
    echo "ERROR: select-raop-sink script not found at $SELECT_SCRIPT" >&2
    exit 1
fi

cp "$SELECT_SCRIPT" "$LOCAL_BIN_DIR/"
chmod +x "$LOCAL_BIN_DIR/select-raop-sink"

# Set ownership if running as root
if [ "$(id -u)" -eq 0 ]; then
    chown "$TARGET_USER:$TARGET_USER" "$LOCAL_BIN_DIR/link-audio-to-raop.py"
    chown "$TARGET_USER:$TARGET_USER" "$LOCAL_BIN_DIR/select-raop-sink"
fi

echo "Installed: $LOCAL_BIN_DIR/link-audio-to-raop.py"
echo "Installed: $LOCAL_BIN_DIR/select-raop-sink"

########################################
# Install the systemd service
########################################
echo "Installing systemd user service..."

# Create systemd user directory
SYSTEMD_USER_DIR="$TARGET_HOME/.config/systemd/user"
mkdir -p "$SYSTEMD_USER_DIR"

# Copy the service file
SERVICE_FILE="$SCRIPT_DIR/raop-audio-link.service"
if [ ! -f "$SERVICE_FILE" ]; then
    echo "ERROR: raop-audio-link.service file not found at $SERVICE_FILE" >&2
    exit 1
fi

cp "$SERVICE_FILE" "$SYSTEMD_USER_DIR/"

# Set ownership if running as root
if [ "$(id -u)" -eq 0 ]; then
    chown -R "$TARGET_USER:$TARGET_USER" "$SYSTEMD_USER_DIR"
fi

echo "Installed: $SYSTEMD_USER_DIR/raop-audio-link.service"

########################################
# Enable and start the service
########################################
echo "Enabling systemd user service..."

# Function to run commands as the target user with proper environment
run_as_user() {
    if [ "$(id -u)" -eq 0 ]; then
        # When running as root, we need to set up the environment properly
        TARGET_UID=$(id -u "$TARGET_USER")
        XDG_RUNTIME_DIR="/run/user/$TARGET_UID"
        
        # Use machinectl to run commands in the user's session if available
        if command -v machinectl >/dev/null 2>&1 && systemctl is-active --quiet user@${TARGET_UID}.service; then
            machinectl shell "$TARGET_USER@" /bin/bash -c "$1"
        else
            # Fallback: set environment and run as user
            su -l "$TARGET_USER" -c "export XDG_RUNTIME_DIR='$XDG_RUNTIME_DIR'; $1"
        fi
    else
        bash -c "$1"
    fi
}

# Check if user session is active
if [ "$(id -u)" -eq 0 ]; then
    TARGET_UID=$(id -u "$TARGET_USER")
    if ! systemctl is-active --quiet user@${TARGET_UID}.service; then
        echo "User session not active. Enabling service for next login..."
        # Just enable without starting - it will start on next login
        run_as_user "systemctl --user daemon-reload" || echo "Note: Service will be loaded on next user login"
        run_as_user "systemctl --user enable raop-audio-link.service" || {
            echo "Warning: Could not enable service via systemctl. Creating enable symlink manually..."
            # Manual enable by creating symlink
            WANTS_DIR="$TARGET_HOME/.config/systemd/user/pipewire.service.wants"
            mkdir -p "$WANTS_DIR"
            ln -sf "../raop-audio-link.service" "$WANTS_DIR/raop-audio-link.service"
            chown -R "$TARGET_USER:$TARGET_USER" "$WANTS_DIR"
            echo "Service will be enabled on next user login."
        }
    else
        # User session is active, try normal enable
        run_as_user "systemctl --user daemon-reload"
        run_as_user "systemctl --user enable raop-audio-link.service"
    fi
else
    # Running as user, normal operation
    run_as_user "systemctl --user daemon-reload"
    run_as_user "systemctl --user enable raop-audio-link.service"
fi

echo ""
echo "Installation complete!"
echo ""
echo "The service will automatically start when PipeWire starts."
echo "To manually control the service:"
echo "  Start:   systemctl --user start raop-audio-link.service"
echo "  Stop:    systemctl --user stop raop-audio-link.service"
echo "  Status:  systemctl --user status raop-audio-link.service"
echo "  Logs:    journalctl --user -u raop-audio-link.service"
echo ""
echo "Note: Make sure to run 'select-raop-sink' first to choose your target AirPlay device."