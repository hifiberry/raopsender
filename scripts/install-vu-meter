#!/usr/bin/env bash
set -euo pipefail

# install-vu-meter
# Installs vumz VU meter from https://github.com/IonelPopJara/vumz
# A real-time audio VU meter for PipeWire/PulseAudio

########################################
# Safety checks and environment
########################################
if [ "$(id -u)" -ne 0 ]; then
  echo "This script requires root. Re-running with sudo..."
  exec sudo bash "$0" "$@"
fi

# Get the actual user (not root when using sudo)
ACTUAL_USER="${SUDO_USER:-$USER}"
if [ "$ACTUAL_USER" = "root" ]; then
  echo "ERROR: Please run this script as a regular user with sudo, not as root directly"
  exit 1
fi

ACTUAL_HOME=$(getent passwd "$ACTUAL_USER" | cut -d: -f6)

########################################
# Helper functions
########################################
log_message() {
  echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

########################################
# Install dependencies
########################################
log_message "Installing dependencies for vumz VU meter..."

# Update package list
apt-get update

# Install required packages
apt-get install -y \
  git \
  build-essential \
  cmake \
  pkg-config \
  libpulse-dev \
  libncurses5-dev \
  libncursesw5-dev \
  libpipewire-0.3-dev

########################################
# Clone and build vumz
########################################
log_message "Cloning vumz from GitHub..."

# Work in /tmp for building
cd /tmp

# Remove any existing clone
rm -rf vumz

# Clone the repository
git clone https://github.com/IonelPopJara/vumz.git

cd vumz

log_message "Building vumz..."

# Create build directory
mkdir -p build
cd build

# Configure with cmake
cmake ..

# Build the project
make -j$(nproc)

########################################
# Install vumz
########################################
log_message "Installing vumz to /usr/local/bin..."

# Install the binary (it's built in the build subdirectory)
cp build/vumz /usr/local/bin/
chmod +x /usr/local/bin/vumz

# Verify installation
if command -v vumz >/dev/null 2>&1; then
  log_message "✅ vumz installed successfully!"
  vumz --version || echo "vumz version: $(vumz --help | head -1)"
else
  log_message "❌ vumz installation failed"
  exit 1
fi

########################################
# Create convenience script
########################################
log_message "Creating convenience script for HiFiBerry monitoring..."

cat > /usr/local/bin/hifiberry-vu << 'EOF'
#!/bin/bash
# hifiberry-vu - Monitor HiFiBerry ADC levels with vumz

# Function to find HiFiBerry source using PipeWire
find_hifiberry_source() {
    local current_node=""
    local node_name=""
    local media_class=""
    
    while IFS= read -r line; do
        # Check for new node
        if [[ $line =~ ^[[:space:]]*id\ ([0-9]+) ]]; then
            # Process previous node if it was an Audio/Source
            if [[ "$media_class" == "Audio/Source" && "$node_name" =~ (platform-soc_sound|hifiberry|sndrpihifiberry) ]]; then
                echo "$node_name"
                return 0
            fi
            # Reset for new node
            current_node="${BASH_REMATCH[1]}"
            node_name=""
            media_class=""
        elif [[ $line =~ node\.name\ =\ \"([^\"]+)\" ]]; then
            node_name="${BASH_REMATCH[1]}"
        elif [[ $line =~ media\.class\ =\ \"([^\"]+)\" ]]; then
            media_class="${BASH_REMATCH[1]}"
        fi
    done < <(pw-cli ls Node)
    
    # Check the last node
    if [[ "$media_class" == "Audio/Source" && "$node_name" =~ (platform-soc_sound|hifiberry|sndrpihifiberry) ]]; then
        echo "$node_name"
        return 0
    fi
    
    return 1
}

# Find HiFiBerry source
HIFIBERRY_SOURCE=$(find_hifiberry_source)

if [ -z "$HIFIBERRY_SOURCE" ]; then
    echo "ERROR: Could not find HiFiBerry audio source"
    echo "Available audio sources:"
    pw-cli ls Node | awk '/media\.class = "Audio\/Source"/ {found=1} found && /node\.name = / {print "  " $0; found=0}'
    echo
    echo "Looking for sources matching: platform-soc_sound, hifiberry, or sndrpihifiberry"
    exit 1
fi

echo "Monitoring HiFiBerry source: $HIFIBERRY_SOURCE"
echo "Press Ctrl+C to stop"
echo

# Run vumz with the HiFiBerry source
exec vumz --source="$HIFIBERRY_SOURCE"
EOF

chmod +x /usr/local/bin/hifiberry-vu

########################################
# Cleanup
########################################
log_message "Cleaning up build files..."
cd /
rm -rf /tmp/vumz

########################################
# Usage information
########################################
log_message "Installation complete!"
echo
echo "Usage:"
echo "  vumz                    # Monitor default audio source"
echo "  hifiberry-vu           # Monitor HiFiBerry ADC specifically"
echo "  vumz --help            # Show all options"
echo
echo "The HiFiBerry VU meter can be started with:"
echo "  hifiberry-vu"
echo