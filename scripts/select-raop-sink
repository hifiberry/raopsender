#!/usr/bin/env bash
set -euo pipefail

# select-raop-sink
# Lists available RAOP sinks and allows user to select one
# Saves the selected sink name to ~/.config/raop-sink-name

########################################
# Check if sink is already configured and exists
########################################
CONFIG_FILE="$HOME/.config/raop-sink-name"

if [ -f "$CONFIG_FILE" ]; then
    CONFIGURED_SINK=$(cat "$CONFIG_FILE" | tr -d '\n' | xargs)
    
    if [ -n "$CONFIGURED_SINK" ]; then
        echo "Checking existing RAOP sink configuration..."
        
        # Check if the configured sink still exists
        if pw-cli ls Node | grep -q "node.name = \"$CONFIGURED_SINK\""; then
            # Get the description and ID of the configured sink
            all_nodes=$(pw-cli ls Node)
            
            # Parse to find the ID and description
            SINK_DESCRIPTION=""
            SINK_ID=""
            current_name=""
            current_description=""
            current_id=""
            
            while IFS= read -r line; do
                if [[ $line =~ ^[[:space:]]*id[[:space:]]+([0-9]+).*type[[:space:]]+PipeWire:Interface:Node ]]; then
                    # Check if previous node was our configured sink
                    if [[ "$current_name" == "$CONFIGURED_SINK" ]]; then
                        SINK_DESCRIPTION="$current_description"
                        SINK_ID="$current_id"
                        break
                    fi
                    
                    # Reset for new node
                    current_id="${BASH_REMATCH[1]:-}"
                    current_name=""
                    current_description=""
                elif [[ $line =~ ^[[:space:]]*node\.name[[:space:]]*=[[:space:]]*\"(.*)\" ]]; then
                    current_name="${BASH_REMATCH[1]:-}"
                elif [[ $line =~ ^[[:space:]]*node\.description[[:space:]]*=[[:space:]]*\"(.*)\" ]]; then
                    current_description="${BASH_REMATCH[1]:-}"
                fi
            done <<< "$all_nodes"
            
            # Check the last node too
            if [ -z "$SINK_ID" ] && [[ "$current_name" == "$CONFIGURED_SINK" ]]; then
                SINK_DESCRIPTION="$current_description"
                SINK_ID="$current_id"
            fi
            
            echo ""
            echo "RAOP sink already configured and available:"
            echo "=========================================="
            echo "Device: $SINK_DESCRIPTION"
            echo "Sink: $CONFIGURED_SINK"
            if [ -n "$SINK_ID" ]; then
                echo "ID: $SINK_ID"
            fi
            echo ""
            echo "Configuration file: $CONFIG_FILE"
            echo ""
            if [ -n "$SINK_ID" ]; then
                echo "Sample commands:"
                echo "  Set as default:     wpctl set-default $SINK_ID"
                echo "  Play audio file:    pw-play --target=\"$CONFIGURED_SINK\" <file>"
                echo "  Check status:       wpctl status"
                echo ""
            fi
            echo "To reconfigure, delete the config file:"
            echo "  rm $CONFIG_FILE"
            echo "Then run this script again."
            echo ""
            exit 0
        else
            echo "Warning: Configured sink '$CONFIGURED_SINK' no longer exists."
            echo "Proceeding with new sink selection..."
            echo ""
        fi
    fi
fi

########################################
# Check if PipeWire is running
########################################
if ! command -v pw-cli >/dev/null 2>&1; then
    echo "Error: pw-cli not found. Please install PipeWire." >&2
    exit 1
fi

if ! pw-cli info >/dev/null 2>&1; then
    echo "Error: PipeWire is not running or accessible." >&2
    exit 1
fi

########################################
# Get RAOP sinks
########################################
echo "Scanning for RAOP (AirPlay) sinks..."

# Get all RAOP sink nodes - simpler approach
all_nodes=$(pw-cli ls Node)

if [ -z "$all_nodes" ]; then
    echo "Error: Could not get node list from PipeWire." >&2
    exit 1
fi

########################################
# Parse and display sinks
########################################
declare -a sink_names=()
declare -a sink_descriptions=()
declare -a sink_ids=()

# Parse node by node to find RAOP sinks
current_node=""
current_name=""
current_description=""
current_media_class=""
current_id=""

while IFS= read -r line; do
    # Check for start of new node
    if [[ $line =~ ^[[:space:]]*id[[:space:]]+([0-9]+).*type[[:space:]]+PipeWire:Interface:Node ]]; then
        # Process previous node if it was a RAOP sink
        if [[ "$current_name" =~ raop_sink\. ]] && [[ "$current_media_class" == "Audio/Sink" ]] && [ -n "$current_description" ]; then
            sink_names+=("$current_name")
            sink_descriptions+=("$current_description")
            sink_ids+=("$current_id")
        fi
        
        # Reset for new node and capture ID
        current_id="${BASH_REMATCH[1]:-}"
        current_name=""
        current_description=""
        current_media_class=""
    elif [[ $line =~ ^[[:space:]]*node\.name[[:space:]]*=[[:space:]]*\"(.*)\" ]]; then
        current_name="${BASH_REMATCH[1]:-}"
    elif [[ $line =~ ^[[:space:]]*node\.description[[:space:]]*=[[:space:]]*\"(.*)\" ]]; then
        current_description="${BASH_REMATCH[1]:-}"
    elif [[ $line =~ ^[[:space:]]*media\.class[[:space:]]*=[[:space:]]*\"(.*)\" ]]; then
        current_media_class="${BASH_REMATCH[1]:-}"
    fi
done <<< "$all_nodes"

# Don't forget the last node
if [[ "$current_name" =~ raop_sink\. ]] && [[ "$current_media_class" == "Audio/Sink" ]] && [ -n "$current_description" ]; then
    sink_names+=("$current_name")
    sink_descriptions+=("$current_description")
    sink_ids+=("$current_id")
fi

if [ ${#sink_names[@]} -eq 0 ]; then
    echo "No RAOP sinks found."
    echo "Make sure:"
    echo "  1. PipeWire RAOP module is loaded (check with: pw-cli ls Module | grep raop)"
    echo "  2. AirPlay devices are available on the network"
    echo "  3. RAOP discovery is working (check with: pw-cli ls Node | grep raop_sink)"
    exit 1
fi

########################################
# Display menu and get user selection
########################################
echo ""
echo "Available RAOP (AirPlay) sinks:"
echo "================================"

for i in "${!sink_names[@]}"; do
    printf "%2d) %s (ID: %s)\n" $((i+1)) "${sink_descriptions[i]}" "${sink_ids[i]}"
done

echo ""
echo -n "Select a sink (1-${#sink_names[@]}): "
read -r selection

# Validate selection
if ! [[ "$selection" =~ ^[0-9]+$ ]] || [ "$selection" -lt 1 ] || [ "$selection" -gt ${#sink_names[@]} ]; then
    echo "Invalid selection. Please enter a number between 1 and ${#sink_names[@]}." >&2
    exit 1
fi

# Get selected sink (adjust for 0-based array)
selected_index=$((selection-1))
selected_sink="${sink_names[selected_index]}"
selected_description="${sink_descriptions[selected_index]}"
selected_id="${sink_ids[selected_index]}"

########################################
# Save selection to config file
########################################
config_dir="$HOME/.config"
config_file="$config_dir/raop-sink-name"

# Create config directory if it doesn't exist
mkdir -p "$config_dir"

# Save the sink name
echo "$selected_sink" > "$config_file"

echo ""
echo "Selected: $selected_description"
echo "Sink name: $selected_sink"
echo "Sink ID: $selected_id"
echo "Saved to: $config_file"
echo ""
echo "You can now use this sink for audio playback with:"
echo "  pw-play --target=\"$selected_sink\" <audio_file>"
echo ""
echo "To set it as default sink:"
echo "  wpctl set-default $selected_id"
echo ""
echo "Or use PipeWire directly:"
echo "  pw-link <source_port> <sink_port>"